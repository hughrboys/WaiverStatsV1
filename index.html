<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiver Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max_width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #333; }
        .section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .section h3 { margin-top: 0; margin-bottom: 15px;}
        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        label { width: 140px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"] { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        .file-group { background: #fafafa; padding: 10px; border-left: 5px solid #ccc; margin-bottom: 10px; }
        .blue-group { border-left-color: #4A90E2; }
        .green-group { border-left-color: #50E3C2; }
        
        /* Filter Section Styles */
        .filter-highlight { background-color: #fff8e1; border-color: #ffe082; }

        button { background-color: #28a745; color: white; border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold;}
        button:hover { background-color: #218838; }
        
        #stats { white-space: pre-wrap; background: #eee; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: monospace; line-height: 1.6; font-size: 14px; border: 1px solid #ccc;}
        canvas { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Waiver Analytics Tool</h1>

    <div class="section">
        <h3>1. Settings</h3>
        <div class="row">
            <label>Participants per Table:</label>
            <input type="number" id="participants" value="10">
        </div>
        <div class="row">
            <label>Hours Operational:</label>
            <input type="number" id="hours" placeholder="Auto-calculated">
            <small style="color:#666; margin-left: 5px;">(Calculated based on filtered range)</small>
        </div>
    </div>

    <div class="section filter-highlight">
        <h3>2. Filter Range (Optional)</h3>
        <div class="row">
            <label>Select Date:</label>
            <input type="date" id="filterDate">
        </div>
        <div class="row">
            <label>Start Time:</label>
            <input type="time" id="filterStart">
        </div>
        <div class="row">
            <label>End Time:</label>
            <input type="time" id="filterEnd">
        </div>
        <small><i>Leave blank to show all data found in files.</i></small>
    </div>

    <div class="section">
        <h3>3. Upload Files</h3>
        
        <div class="file-group blue-group">
            <div class="row">
                <label>Blue Label:</label>
                <input type="text" id="label1" value="Waiver language 1">
            </div>
            <div class="row">
                <label>Select CSV:</label>
                <input type="file" id="file1" accept=".csv" onchange="previewFile(this)">
            </div>
        </div>

        <div class="file-group green-group">
            <div class="row">
                <label>Green Label:</label>
                <input type="text" id="label2" value="Waiver language 2">
            </div>
            <div class="row">
                <label>Select CSV:</label>
                <input type="file" id="file2" accept=".csv">
            </div>
        </div>
    </div>

    <button onclick="processData()">Generate Graph & Stats</button>

    <div id="stats">upload files to see stats...</div>
    <canvas id="myChart"></canvas>
</div>

<script>
    let chartInstance = null;
    
    // Helper: Check if string has digits
    function containsDigit(str) {
        return /\d/.test(str);
    }

    // Helper: Parse Date "MM/DD/YYYY HH:MM:SS"
    function parseDate(str) {
        if(!str) return null;
        const parts = str.split(' ');
        if(parts.length < 2) return null;
        const dateParts = parts[0].split('/');
        const timeParts = parts[1].split(':');
        if(dateParts.length < 3 || timeParts.length < 3) return null;
        
        return new Date(dateParts[2], dateParts[0]-1, dateParts[1], timeParts[0], timeParts[1], timeParts[2]);
    }

    // Helper: Format Date for display
    function formatDateTime(dateObj) {
        const mm = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const dd = dateObj.getDate().toString().padStart(2, '0');
        const yyyy = dateObj.getFullYear();
        const hh = dateObj.getHours().toString().padStart(2, '0');
        const min = dateObj.getMinutes().toString().padStart(2, '0');
        return `${mm}/${dd}/${yyyy} ${hh}:${min}`;
    }

    // Helper: Round date down to 15 min
    function floorTo15Min(date) {
        const d = new Date(date);
        const min = d.getMinutes();
        const rem = min % 15;
        d.setMinutes(min - rem);
        d.setSeconds(0);
        d.setMilliseconds(0);
        return d;
    }

    // Utility: Format Date object to "YYYY-MM-DD" for input comparison
    function getISODate(dateObj) {
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Pre-fill date picker when file is selected
    function previewFile(input) {
        if(input.files && input.files[0]) {
            Papa.parse(input.files[0], {
                preview: 5, 
                complete: function(results) {
                    for(let i=1; i<results.data.length; i++){
                        const dt = parseDate(results.data[i][0]);
                        if(dt) {
                            document.getElementById('filterDate').value = getISODate(dt);
                            break;
                        }
                    }
                }
            });
        }
    }

    // --- Main Logic ---

    async function processData() {
        const file1Input = document.getElementById('file1');
        const file2Input = document.getElementById('file2');
        
        const p1 = file1Input.files[0] ? parseCSV(file1Input.files[0]) : Promise.resolve([]);
        const p2 = file2Input.files[0] ? parseCSV(file2Input.files[0]) : Promise.resolve([]);

        Promise.all([p1, p2]).then(results => {
            const [raw1, raw2] = results;
            
            if (raw1.length === 0 && raw2.length === 0) {
                alert("Please upload at least one CSV file.");
                return;
            }

            // 2. Apply Filters
            const filterDate = document.getElementById('filterDate').value;
            const filterStart = document.getElementById('filterStart').value;
            const filterEnd = document.getElementById('filterEnd').value;

            // Function to filter and bin data
            const processSet = (rawData) => {
                let validParticipants = 0;
                let validWaivers = 0;
                let intervalDict = {};
                let filteredTimes = [];

                rawData.forEach(item => {
                    const itemDateStr = getISODate(item.dt); // YYYY-MM-DD

                    // A. Filter by Date
                    if (filterDate && itemDateStr !== filterDate) return;

                    // B. Filter by Time
                    if (filterStart) {
                        const [sh, sm] = filterStart.split(':');
                        const startLimit = new Date(item.dt);
                        startLimit.setHours(sh, sm, 0, 0);
                        if (item.dt < startLimit) return;
                    }
                    if (filterEnd) {
                        const [eh, em] = filterEnd.split(':');
                        const endLimit = new Date(item.dt);
                        endLimit.setHours(eh, em, 0, 0);
                        if (item.dt > endLimit) return;
                    }

                    // If we pass filters:
                    validWaivers++;                 // Count the waiver (row)
                    validParticipants += item.count; // Count people on it
                    filteredTimes.push(item.dt.getTime());

                    // Binning (Using participant count for the graph height)
                    const floored = floorTo15Min(item.dt).getTime();
                    intervalDict[floored] = (intervalDict[floored] || 0) + item.count;
                });

                return { 
                    participants: validParticipants, 
                    waivers: validWaivers, 
                    intervals: intervalDict, 
                    times: filteredTimes 
                };
            };

            const d1 = processSet(raw1);
            const d2 = processSet(raw2);

            // 3. Calculate Hours (Based on FILTERED data)
            const allTimes = [...d1.times, ...d2.times];
            let hours = 0;
            let titleLines = [];

            if (allTimes.length > 0) {
                const minTime = new Date(Math.min(...allTimes));
                const maxTime = new Date(Math.max(...allTimes));
                
                const calcHours = (maxTime - minTime) / 1000 / 3600;

                // Update hours input
                document.getElementById('hours').value = calcHours.toFixed(2);
                hours = calcHours;

                // --- Generate Title ---
                let filename = "";
                if (file1Input.files[0]) filename = file1Input.files[0].name;
                else if (file2Input.files[0]) filename = file2Input.files[0].name;
                
                const raceName = filename.split(" - ")[0] || "Combined Analytics";
                const dayName = minTime.toLocaleDateString('en-US', { weekday: 'long' });
                const timeFrameStr = `Time frame: ${formatDateTime(minTime)} - ${formatDateTime(maxTime)}`;

                titleLines = [raceName, dayName, timeFrameStr];
            } else {
                titleLines = ["No data found matching filters"];
                document.getElementById('hours').value = 0;
            }

            // 4. Calculate Dwell Time
            const participantsPerTable = parseInt(document.getElementById('participants').value) || 10;
            const totalParticipants = d1.participants + d2.participants;
            const totalWaivers = d1.waivers + d2.waivers;
            let dwellStr = "N/A";
            
            if (totalParticipants > 0 && hours > 0) {
                const totalMins = (participantsPerTable * hours * 60) / totalParticipants;
                const m = Math.floor(totalMins);
                const s = Math.round((totalMins - m) * 60);
                dwellStr = `${m}m ${s}s`;
            }

            // 5. Update Text Stats
            const label1 = document.getElementById('label1').value || "Group 1";
            const label2 = document.getElementById('label2').value || "Group 2";
            
            // Calculate Average Group Size
            let avgGroupSize = "0";
            if (totalWaivers > 0) {
                avgGroupSize = (totalParticipants / totalWaivers).toFixed(2);
            }

            const statsDiv = document.getElementById('stats');
            statsDiv.innerText = 
                `Time Window Analyzed:   ${hours.toFixed(2)} hours\n` +
                `----------------------------------------\n` +
                `TOTAL WAIVERS SIGNED:   ${totalWaivers}\n` +
                `TOTAL PARTICIPANTS:     ${totalParticipants}\n` +
                `Avg Participants/Waiver: ${avgGroupSize}\n` +
                `----------------------------------------\n` +
                `Breakdown by Group:\n` +
                `   - ${label1}: ${d1.waivers} waivers / ${d1.participants} participants\n` +
                `   - ${label2}: ${d2.waivers} waivers / ${d2.participants} participants\n` +
                `----------------------------------------\n` +
                `Calculated Dwell Time:  ${dwellStr}`;

            // 6. Render Chart
            renderChart(d1.intervals, d2.intervals, label1, label2, titleLines);
        });
    }

    function parseCSV(file) {
        return new Promise((resolve) => {
            Papa.parse(file, {
                complete: function(results) {
                    let rawData = [];

                    // Skip header (row 0)
                    for (let i = 1; i < results.data.length; i++) {
                        const row = results.data[i];
                        if (row.length < 1) continue;
                        
                        const dt = parseDate(row[0]);
                        if (!dt) continue;

                        // Count participants in specific columns
                        let rowValid = 0;
                        [3, 5, 7, 9, 11, 13].forEach(idx => {
                            if (row[idx]) {
                                const val = row[idx].trim();
                                if (val && !containsDigit(val)) rowValid++;
                            }
                        });

                        // We store the row even if 0 participants, 
                        // because it counts as a waiver signed (timestamp exists)
                        rawData.push({ dt: dt, count: rowValid });
                    }
                    resolve(rawData);
                }
            });
        });
    }

    function renderChart(dict1, dict2, label1, label2, titleArray) {
        const ctx = document.getElementById('myChart').getContext('2d');
        
        const keys = new Set([...Object.keys(dict1), ...Object.keys(dict2)]);
        const sortedKeys = Array.from(keys).sort();

        const labels = sortedKeys.map(k => {
            const d = new Date(parseInt(k));
            return d.getHours().toString().padStart(2,0) + ":" + d.getMinutes().toString().padStart(2,0);
        });

        const data1 = sortedKeys.map(k => dict1[k] || 0);
        const data2 = sortedKeys.map(k => dict2[k] || 0);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: label1,
                        data: data1,
                        backgroundColor: '#4A90E2',
                        stack: 'Stack 0',
                    },
                    {
                        label: label2,
                        data: data2,
                        backgroundColor: '#50E3C2',
                        stack: 'Stack 0',
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: titleArray,
                        font: { size: 16 },
                        padding: { top: 10, bottom: 20 },
                        color: '#333'
                    },
                    legend: { position: 'top' }
                },
                scales: {
                    x: { stacked: true, title: { display: true, text: 'Time (15-min intervals)' } },
                    y: { stacked: true, title: { display: true, text: 'Number of Participants' } }
                }
            }
        });
    }
</script>

</body>
</html>
